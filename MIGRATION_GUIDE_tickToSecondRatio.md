# BWV-Zeug Pipeline Migration: Removing tickToSecondRatio

## Overview

The BWV-Zeug pipeline has been updated to support **dynamic tempo synchronization** with real audio performances. As part of this enhancement, the `tickToSecondRatio` field has been **completely removed** from all YAML files and Python scripts, as it added no value and caused confusion.

## What Changed

### Before (Old System)
- YAML files contained `meta.tickToSecondRatio` field
- Tick values were converted to time using: `time = tick * tickToSecondRatio`
- This worked only for static MIDI tempo

### After (New System)
- **No `tickToSecondRatio` field** in YAML files
- **Time-based tick system**: 1 tick = 1 millisecond
- Tick values directly represent time in milliseconds throughout the file
- Supports dynamic tempo from real audio performances

## YAML File Format Changes

### Old Format
```yaml
meta:
  totalMeasures: 11
  minTick: 0
  maxTick: 16896
  tickToSecondRatio: 0.001234  # ← REMOVED
  # ... other fields
flow:
- [0, 4, 384, ['file.ly:1:1']]      # Old tick values
- [384, 3, 768, ['file.ly:1:5']]    # Required conversion
```

### New Format
```yaml
meta:
  totalMeasures: 11
  minTick: 0
  maxTick: 56676
  # tickToSecondRatio field completely removed
  # ... other fields
flow:
- [1420, 4, 2460, ['file.ly:1:1']]  # Direct time values (milliseconds)
- [2460, 3, 3870, ['file.ly:1:5']]  # No conversion needed
```

## Required Code Changes

### 1. Remove tickToSecondRatio Dependencies

**Search for and remove:**
- Any code that reads `meta.tickToSecondRatio`
- Any code that writes `tickToSecondRatio` to YAML
- Calculations like `time = tick * tickToSecondRatio`

### 2. Handle Missing Field Gracefully

**Before:**
```python
# This will now fail
tick_to_second = meta['tickToSecondRatio']
time = tick * tick_to_second
```

**After:**
```python
# Handle both old and new formats
tick_to_second = meta.get('tickToSecondRatio')
if tick_to_second is not None:
    # Old format: convert ticks to time
    time = tick * tick_to_second
else:
    # New format: ticks ARE time (in milliseconds)
    time = tick / 1000.0  # Convert to seconds if needed
```

### 3. Update Time Conversion Logic

**For new YAML files (audio-synced):**
- **All tick values** are in milliseconds (1 tick = 1 millisecond)
- To convert to seconds: `seconds = tick / 1000.0`
- No ratio calculation needed
- Metadata (`minTick`, `maxTick`) is consistent with flow events

### 4. Backwards Compatibility

If you need to support both old and new formats:

```python
def get_time_from_tick(tick, meta):
    """Convert tick to time, handling both old and new formats."""
    tick_to_second = meta.get('tickToSecondRatio')
    
    if tick_to_second is not None:
        # Old format: use ratio conversion
        return tick * tick_to_second
    else:
        # New format: ticks are milliseconds
        return tick / 1000.0  # Convert to seconds
```

## File Types Affected

### YAML Files to Check
- Any files consuming BWV-Zeug outputs
- Visualization or playback systems
- Analysis tools that read timing data

### Audio-Synced Files (New Format)
- Files ending in `_audio_sync.yaml` or `_audio.yaml`
- Generated by the new `sync_with_audio.py` script
- Always use time-based ticks (no `tickToSecondRatio`)

## Testing Strategy

1. **Check for `tickToSecondRatio` usage:**
   ```bash
   grep -r "tickToSecondRatio" your_project/
   ```

2. **Test with both formats:**
   - Old YAML files (with `tickToSecondRatio`)
   - New audio-synced YAML files (without `tickToSecondRatio`)

3. **Verify time calculations:**
   - Ensure timing remains accurate
   - Check visualization alignment
   - Test audio synchronization

## Benefits of New System

✅ **Direct time representation** - no conversion needed  
✅ **Audio synchronization** - works with dynamic tempo  
✅ **Simplified pipeline** - removes unnecessary conversion step  
✅ **Better accuracy** - eliminates rounding errors from ratio multiplication  

## Example Migration

**Old code:**
```python
# Load YAML
with open('score.yaml') as f:
    data = yaml.safe_load(f)

# Convert ticks to time (OLD WAY)
ratio = data['meta']['tickToSecondRatio']
for event in data['flow']:
    start_tick, channel, end_tick, info = event
    start_time = start_tick * ratio
    end_time = end_tick * ratio
```

**New code:**
```python
# Load YAML
with open('score.yaml') as f:
    data = yaml.safe_load(f)

# Convert ticks to time (NEW WAY - handles both formats)
ratio = data['meta'].get('tickToSecondRatio')
for event in data['flow']:
    start_tick, channel, end_tick, info = event
    
    if ratio is not None:
        # Old format
        start_time = start_tick * ratio
        end_time = end_tick * ratio
    else:
        # New format (ticks = milliseconds)
        start_time = start_tick / 1000.0
        end_time = end_tick / 1000.0
```

## Questions?

If you encounter issues during migration:
1. Check if the YAML file has `tickToSecondRatio` field
2. Verify tick values make sense (new format has larger numbers)
3. Test timing accuracy with known audio files
4. Consider backwards compatibility needs

The new system is more robust and supports both static MIDI timing and dynamic audio tempo synchronization!